<%page expression_filter="h"/>
<%inherit file="main.html" />
<%def name="online_help_token()"><% return "learnerdashboard" %></%def>
<%namespace name='static' file='static_content.html'/>
<%!
import pytz
from datetime import datetime, timedelta
from django.core.urlresolvers import reverse
from django.utils.translation import ugettext as _
from django.utils.translation import ungettext
from django.template import RequestContext
from entitlements.models import CourseEntitlement
from third_party_auth import pipeline
from util.date_utils import strftime_localized
from opaque_keys.edx.keys import CourseKey
from openedx.core.djangoapps.content.course_overviews.models import CourseOverview
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import HTML, Text

from student.models import CourseEnrollment
%>

<%
cert_name_short = settings.CERT_NAME_SHORT
cert_name_long = settings.CERT_NAME_LONG
%>


<%block name="pagetitle">${_("Dashboard")}</%block>
<%block name="bodyclass">view-dashboard is-authenticated</%block>

<%block name="header_extras">
% for template_name in ["donation"]:
<script type="text/template" id="${template_name}-tpl">
  <%static:include path="dashboard/${template_name}.underscore" />
</script>
% endfor
</%block>

<%block name="js_extra">
<script src="${static.url('js/commerce/credit.js')}"></script>
<%static:js group='dashboard'/>
<script type="text/javascript">
  $(document).ready(function() {
    edx.dashboard.legacy.init({
      dashboard: "${reverse('dashboard') | n, js_escaped_string}",
      signInUser: "${reverse('signin_user') | n, js_escaped_string}",
      changeEmailSettings: "${reverse('change_email_settings') | n, js_escaped_string}"
    });
  });
</script>
<%static:webpack entry="UnenrollmentFactory">
UnenrollmentFactory({
urls: {
dashboard: "${reverse('dashboard') | n, js_escaped_string}",
signInUser: "${reverse('signin_user') | n, js_escaped_string}",
changeEmailSettings: "${reverse('change_email_settings') | n, js_escaped_string}",
browseCourses: "${marketing_link('COURSES') | n, js_escaped_string}"
},
isEdx: false
});
</%static:webpack>
<%static:webpack entry="EntitlementUnenrollmentFactory">
## Wait until the document is fully loaded before initializing the EntitlementUnenrollmentView
## to ensure events are setup correctly.
$(document).ready(function() {
EntitlementUnenrollmentFactory({
dashboardPath: "${reverse('dashboard') | n, js_escaped_string}",
signInPath: "${reverse('signin_user') | n, js_escaped_string}",
browseCourses: "${marketing_link('COURSES') | n, js_escaped_string}",
isEdx: false
});
});
</%static:webpack>
% if settings.FEATURES.get('ENABLE_DASHBOARD_SEARCH'):
<%static:require_module module_name="course_search/js/dashboard_search_factory" class_name="DashboardSearchFactory">
DashboardSearchFactory();
</%static:require_module>
% endif
% if redirect_message:
<%static:require_module module_name="js/views/message_banner" class_name="MessageBannerView">
var banner = new MessageBannerView({urgency: 'low', type: 'warning'});
$('#content').prepend(banner.$el);
banner.showMessage(${redirect_message | n, dump_js_escaped_json})
</%static:require_module>
% endif
</%block>

<!--TODO: go throught everything above this line and see what we actually need here -->
<!--TODO: do we want dashboard notifications?? -->
<!--TODO: why is the styling different-->
<!--TODO: replace all course things with journal things-->
<!--TODO: replace journal uuid w/ journal slug -->


<main id="main" aria-label="Content" tabindex="-1">
  <div class="dashboard" id="dashboard-main">
    <div class="main-container">
      <div class="my-courses" id="my-courses">
        <!--TODO: make it say My Journals -->
        <%include file="learner_dashboard/_dashboard_navigation_courses.html"/>

        % if len(journals) > 0:
        <ul class="listing-courses">
          % for journal in journals:
          <li class="course-item">
            <div class="course-container">
              <!--TODO: course overview language - i don't know what its doing but it sounds important -->
              <!--TODO: come up w/ appropraite aria label -->
              <article class="course" aria-labelledby="" id="course-card-${journal['uuid']}">
                <!--TODO: link article to appropriate journal page -->
                <section class="details" aria-labelledby="details-heading-${journal['uuid']}">
                  <h2 class="hd hd-2 sr" id="details-heading-${journal['uuid']}">$_('Journal details')}</h2>
                  <div class="wrapper-course-image" aria-label="true">
                    <a href="${journal['overview'].about_page_url}" class="cover" tabindex="-1">
                      <img src="${journal['journal']['journalaboutpage']['card_image_absolute_url']}" class="course-image" alt="${_('{journal_title} Cover Image').format(journal_title=journal['journal']['name'])}"/>
                    </a>
                  </div>
                  <div class="wrapper-course-details">
                    <h3 class="course-title" id="course-title-${journal['uuid']}" href="${journal['overview'].about_page_url}">
                      <a data-course-key="${journal['uuid']}">${journal['journal']['name']}</a>
                    </h3>
                    <div class="course-info">
                      <span class="info-university">${journal['journal']['organization']}</span>
                      <!--TODO: handle case where user used to have access to a course and no longer does -->
                      <span class="info-date-block-container">
                      <!--TODO: i18n concerns - do the correct plural thing here -->
                        % if journal['overview'].has_access_expired:
                          <span class="info-date-block" aria-live="polite">
                            <span class="icon fa fa-warning" aria-hidden="true"></span>
                            ${_('Access Expired: {date}').format(date=journal['overview'].expiration_date_formatted)}
                          </span>
                        % else:
                          <span class="info-date-block">
                            ${_('Access Expires: {date}').format(date=journal['overview'].expiration_date_formatted)}
                          </span>
                        % endif
                      </span>
                    </div>
                  </div>
                  <div class="wrapper-course-actions">
                    <div class="course-actions">
                      % if journal['overview'].has_access_expired:
                      <a href="${journal['overview'].about_page_url}"
                         class="enter-course"
                         data-course-key="${journal['uuid']}">
                        ${_('Renew Access')}
                        <span class="sr">
                          ${journal['overview'].title}
                        </span>
                      </a>
                      % else:
                      <a href="${journal['overview'].about_page_url}"
                         class="enter-course"
                         data-course-key="${journal['uuid']}">
                        ${_('View Journal')}
                        <span class="sr">
                          ${journal['overview'].title}
                        </span>
                      </a>
                      % endif
                    </div>
                  </div>
                </section>
              </article>
            </div>
          </li>
          % endfor
        </ul>
        % else:
        <!-- TODO: deal with case where there are no jouranls -->
        % endif
      </div>
    </div>
  </div>
</main>